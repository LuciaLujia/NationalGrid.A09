---
title: "Exploration"
author: "A09"
date: "12/04/2021"
output: html_document
---

```{r}

# Libraries
library(readxl)
library(tidyverse)
library(ggplot2)
library(zoo) # For computing moving averages 

```

### Load ,clean and reformat data

```{r}

flow_2020= read_excel("Flow 2020.xlsx", sheet=2, na="NA")
eu_2020= read_excel("EU 2020 .xlsx", sheet=2, na="NA")
flow_2019= read_excel("Flow 2019.xlsx", sheet=2, na="NA")
eu_2019= read_excel("EU 2019 .xlsx", sheet=2, na="NA")

# Join data for 2020 and 2019
eu_generation <- rbind(eu_2019, eu_2020)

# Make interconnector flows between GB and its neighbors consistent with the rest of the dataset
flow_2020 <- flow_2020 %>% 
  mutate(GB...FR= -FR.GB,
         GB...NL = -NL.GB,
         GB...BE= -BE.GB,
         GB...IE= -IE.GB,
         GB...GB.NIR= -GB_NIR.GB
         )

flow_2019 <- flow_2019 %>% 
  mutate(GB...FR= -FR.GB,
         GB...NL = -NL.GB,
         GB...BE= -BE.GB,
         GB...IE= -IE.GB,
         GB...GB.NIR= -GB_NIR.GB
         )



```

## Calculation of carbon intensity 

```{r}

# Calculate total generation and compute difference between demand and generation
eu_generation <- eu_generation %>% 
  mutate(Generation= rowSums(dplyr::across(3:22), na.rm = T),
         Difference= Generation-Demand) 

# Group fuel types according to carbon intensity (Oil has been grouped with coal for now- awaiting further clarification from client )
gas = c("Fossil.Gas")
coal= c("Fossil.Brown.coal.Lignite", "Fossil.Hard.coal", "Fossil.Peat", "Fossil.Coal.derived.gas", "Fossil.Oil", "Other", "Embedded Other")
renewables_nuke= c("Geothermal", "Hydro.Pumped.Storage", "Hydro.Run.of.river.and.poundage", "Hydro.Water.Reservoir", "Nuclear", "Other.renewable", "Solar", "Wind.Offshore", "Wind.Onshore", "Embedded.Wind")
biomass_waste= c("Biomass", "Waste")

# Carbon intensiy of fuel in Tonnes/MWh
gas_CI= 0.3648
coal_CI=0.9455
biomass_CI= 0.0459
renewables_nuke_CI=0

         
# Percentage of total generation from each fuel/asset type-Hourly
eu_generation_percentage <- as.data.frame(cbind(eu_generation %>% select(1:2), (eu_generation %>% select(3:22))/rowSums((eu_generation %>% select(3:22)))))
  

# Calculate carbon intensity of each fuel/asset type-Hourly

for(i in 1:ncol(eu_generation_percentage)){
  if(colnames(eu_generation_percentage)[i] %in%  gas)
  {
    eu_generation_percentage[,i] <- eu_generation_percentage[,i]*gas_CI
  }
  else if(colnames(eu_generation_percentage)[i] %in%  coal)
  {
    eu_generation_percentage[,i] <- eu_generation_percentage[,i]*coal_CI
  }
   else if(colnames(eu_generation_percentage)[i] %in%  biomass_waste)
  {
    eu_generation_percentage[,i] <- eu_generation_percentage[,i]*biomass_CI
   }
  else if(colnames(eu_generation_percentage)[i] %in%  renewables_nuke)
  {
    eu_generation_percentage[,i] <- eu_generation_percentage[,i]*renewables_nuke_CI
   }
}

# Calculate the total hourly carbon intensity of each Megawatt hour of energy generated by each country (in kg/MWh)
eu_generation_CI <- 
  eu_generation_percentage %>% 
  mutate(carbon_intensity = 1000*rowSums(dplyr::across(3:22), na.rm = T))



```

### Plot 2 month moving average for the carbon intensities of Britain, Germany, France, Norway, Sweden

```{r, fig.height=8, fig.width=12, warning=FALSE}


eu_generation_CI %>% 
  filter(Country== "GB") %>%
  mutate(carbon_intensity_MA= rollmean(carbon_intensity, k = 1440, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= carbon_intensity_MA))+
  geom_line()


eu_generation_CI %>% 
  filter(Country== "DE") %>% 
  mutate(carbon_intensity_MA= rollmean(carbon_intensity, k = 1440, fill = NA)) %>%
  ggplot(aes(x=Datetime, y= carbon_intensity_MA))+
  geom_line()

eu_generation_CI %>% 
  filter(Country== "FR") %>% 
  mutate(carbon_intensity_MA= rollmean(carbon_intensity, k = 1440, fill = NA)) %>%
  ggplot(aes(x=Datetime, y= carbon_intensity_MA))+
  geom_line()

eu_generation_CI %>% 
  filter(Country== "NO") %>% 
  mutate(carbon_intensity_MA= rollmean(carbon_intensity, k = 1440, fill = NA)) %>%
  ggplot(aes(x=Datetime, y= carbon_intensity_MA))+
  geom_line()


eu_generation_CI %>% 
  filter(Country== "SE") %>% 
  mutate(carbon_intensity_MA= rollmean(carbon_intensity, k = 1440, fill = NA)) %>%
  ggplot(aes(x=Datetime, y= carbon_intensity_MA))+
  geom_line()


```

### Plot 2 week moving average for the demand of Britain, Germany, France, Norway, Sweden

```{r, fig.height=8, fig.width=12, warning=FALSE}


eu_generation %>% 
  filter(Country== "GB") %>%
  mutate(demand_MA= rollmean(Demand, k = 336, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= demand_MA))+
  geom_line()

eu_generation %>% 
  filter(Country== "FR") %>%
  mutate(demand_MA= rollmean(Demand, k = 336, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= demand_MA))+
  geom_line()

eu_generation %>% 
  filter(Country== "NO") %>%
  mutate(demand_MA= rollmean(Demand, k = 336, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= demand_MA))+
  geom_line()

eu_generation %>% 
  filter(Country== "SE") %>%
  mutate(demand_MA= rollmean(Demand, k = 336, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= demand_MA))+
  geom_line()

eu_generation %>% 
  filter(Country== "DE") %>%
  mutate(demand_MA= rollmean(Demand, k = 336, fill = NA)) %>% 
  ggplot(aes(x=Datetime, y= demand_MA))+
  geom_line()



```