---
title: "Forecasting"
author: "A09"
date: "12/04/2021"
output: 
    html_document:
      number_sections: true
      highlight: haddock
      theme: spacelab
      toc: yes
      toc_depth: 4
      toc_float:
        collapsed: false
      fontzize: 10pt
---

# Set Up

```{r, warning=FALSE, message=FALSE}

# Libraries
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo) # For computing moving averages 
library(GGally)
library(caret) 
library(lubridate)
library(rsample)
library(tseries)
library(forecast)
library(vars)
library(car)
# library(HDeconometrics)
library(Metrics)
library(scales) # stop abbreviated labeling
library(TSstudio) # split time series data
library(gridExtra) # arrange plots in one place
library(tseries)
library(RColorBrewer)
library(kableExtra)

```

# Load ,clean and reformat data

```{r, warning=FALSE, message=FALSE}
#Import flow and generation data 2019-2020
flow_2020= read_excel("Flow 2020.xlsx", sheet=2, na="NA")
eu_2020= read_excel("EU 2020 .xlsx", sheet=2, na="NA")
flow_2019= read_excel("Flow 2019.xlsx", sheet=2, na="NA")
eu_2019= read_excel("EU 2019 .xlsx", sheet=2, na="NA")

# Import flow and generation data from 2016-2018
flow_1618 <- read_excel("flow_2016_2018.xlsx")
eu_1618 <- read_csv("EU 2016-18.csv")

# Import demand data for France
# demand_1618 <- read_csv("Demand_FR.csv")

# Load data on the carbon intensities of each generation technology
carbon_intensities <- read_excel("Technology CO2 Intensity.xlsx") 
carbon_intensities <- carbon_intensities[3, 2:21]

# Join data for 2020 and 2019
eu_1920 <- rbind(eu_2019, eu_2020) %>% 
# Remove negative generation, calculate total generation and compute difference between demand and generation
   mutate_at(3:23, function(x) ifelse(x<0,0,x)) 

# Make interconnector flows between GB and its neighbors consistent with the rest of the dataset
flow_2020 <- flow_2020 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

flow_2019 <- flow_2019 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

# Convert flow and generation data to monthly
flow_1920 <- as.data.frame(rbind(flow_2019, flow_2020)) %>%
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Datetime) %>% 
  summarise_at(1:59, sum, na.rm=TRUE) 
  
  
eu_1920 <- eu_1920 %>% 
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Datetime, Country) %>% 
  summarise_at(1:21, sum, na.rm=TRUE) 

eu_1618 <- eu_1618 %>% 
  mutate(Country= as.character(str_match_all(Country, "(?<=\\().+?(?=\\))")),
         Embedded.Wind=0,
         Embedded.other=0)
 
# Combine relevant interconnector flows
relevant_IF <- colnames(flow_1618)

flow_1920 <- flow_1920 %>% 
  dplyr::select(1,matches(relevant_IF))

# Combine interconnector flows 2016-2020
flow <- rbind(flow_1618, flow_1920)

# Combine generation for years 2016-2020
eu_1920_mod <- eu_1920 %>% 
  dplyr::select(-Demand) %>% 
  ungroup()

eu_generation <- rbind(eu_1618, eu_1920_mod)

```

# Merge attributes

```{r}

# merge renewable attributes into fewer
colnames(eu_generation)

data1 <- eu_generation %>% 
  
  mutate(Hydro = Hydro.Pumped.Storage + Hydro.Run.of.river.and.poundage + Hydro.Water.Reservoir,
         Wind = Wind.Offshore + Wind.Onshore + Embedded.Wind,
         Other.renewable = Other.renewable + Geothermal,
         total_generation =  Biomass+Fossil.Brown.coal.Lignite+Fossil.Coal.derived.gas+Fossil.Gas+
                 Fossil.Hard.coal+Fossil.Oil+Fossil.Peat+Geothermal+Hydro.Pumped.Storage+
                 Hydro.Run.of.river.and.poundage+Hydro.Water.Reservoir+Nuclear+
                 Other+Other.renewable+Solar+Waste+Wind.Offshore+Wind.Onshore+Embedded.Wind+Embedded.other
         ) %>% 

  dplyr::select(-c(Geothermal, Hydro.Pumped.Storage, Hydro.Run.of.river.and.poundage,
       Hydro.Water.Reservoir, Wind.Offshore, Wind.Onshore, Embedded.Wind))

data1

# colnames(data1)

```

# Trend plot

```{r, fig.width=12, fig.height=8, warning=FALSE}

# Plot

cbbPalette <- c("#000000", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# extract France and GB data
agg_data <- eu_generation %>% 
  
  filter(Country == c("FR","GB")) %>% 

  mutate(Coal = Fossil.Brown.coal.Lignite + Fossil.Hard.coal,
         Gas = Fossil.Coal.derived.gas + Fossil.Gas,
         Hydro = Hydro.Pumped.Storage + Hydro.Run.of.river.and.poundage + Hydro.Water.Reservoir,
         Wind = Wind.Offshore + Wind.Onshore + Embedded.Wind,
         Other.renewable = Other.renewable + Geothermal,
         total_generation =  Biomass+Fossil.Brown.coal.Lignite+Fossil.Coal.derived.gas+Fossil.Gas+
               Fossil.Hard.coal+Fossil.Oil+Fossil.Peat+Geothermal+Hydro.Pumped.Storage+
               Hydro.Run.of.river.and.poundage+Hydro.Water.Reservoir+Nuclear+
               Other+Other.renewable+Solar+Waste+Wind.Offshore+Wind.Onshore+Embedded.Wind+Embedded.other
         ) %>% 
  
  dplyr::select(-c(Fossil.Brown.coal.Lignite, Fossil.Coal.derived.gas, Fossil.Gas, Fossil.Hard.coal,
       Fossil.Oil, Fossil.Peat, Geothermal, Hydro.Pumped.Storage, Hydro.Run.of.river.and.poundage,
       Hydro.Water.Reservoir, Other, Wind.Offshore, Wind.Onshore, Embedded.Wind, Embedded.other)) 

# generate plot

agg_data %>% 
  pivot_longer(cols = colnames(agg_data)[3:12], names_to = "Energy.Type", values_to = "Megawatt") %>% 
  filter(Energy.Type != "total_generation") %>% 
  ggplot(mapping = aes(x = Datetime, y = Megawatt, colour = Energy.Type)) +
  geom_line(size = 1.5) + 
  theme_minimal() + 
  scale_y_continuous(labels = comma) + 
  labs(title = "Energy Generation", 
       x = "Months", 
       y = "Megawatt (MW)"
       ) + 
  facet_wrap(~Country) +
  scale_colour_manual(values=cbbPalette)


```


# Correlation

```{r, warning=FALSE}

# Correlation
cor_FR <- agg_data %>% 
  filter(Country == "FR") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20, legend.size = 6)

cor_GB <- agg_data %>% 
  filter(Country == "GB") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20, legend.size = 6)

grid.arrange(cor_FR,cor_GB,nrow=1)

# ggpairs
agg_data %>% 
  filter(Country == "FR") %>% 
  dplyr::select(Nuclear, Hydro, Wind, Gas, Coal, total_generation) %>% 
  ggpairs(progress = FALSE)

```



# VAR preditions

## GB Prediction

### Time series data preparation

```{r, warning = FALSE}

# Extract country data
data1.GB <- data1 %>% filter(Country == "GB")

# Create time series for each variable (exclude total generation)
Biomass.ts <- as.ts(data1.GB["Biomass"]) 
Fossil.Gas.ts <- as.ts(data1.GB["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.GB["Fossil.Hard.coal"]) 
Nuclear.ts <- as.ts(data1.GB["Nuclear"]) 
Other.ts <- as.ts(data1.GB["Other"]) 
Solar.ts <- as.ts(data1.GB["Solar"]) 
Hydro.ts <- as.ts(data1.GB["Hydro"]) 
Wind.ts <- as.ts(data1.GB["Wind"]) 

original_list <- list(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Hydro.ts, Wind.ts)

original_name_list <- list("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Hydro", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```


### Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Hydro.ts, Wind.ts)

colnames(v1) <- cbind("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Hydro", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 5, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 5, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)

# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Biomass, forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Nuclear, forecast1$fcst$Other, forecast1$fcst$Solar, forecast1$fcst$Hydro, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Biomass, forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Nuclear, forecast2$fcst$Other, forecast2$fcst$Solar, forecast2$fcst$Hydro, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg


# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```




### Prediction

```{r, message=FALSE, fig.width= 7, fig.height=4}

options(scipen=999)

# Model building
Model <- VAR(v1/1000, p = 5, type = "const", season = NULL, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  fanchart(forecast, 
           colors = c("#006D2C", "#31A354", "#74C476", "#BAE4B3", "#EDF8E9"),
           names = original_name_list[[i]], 
           main = paste("Forecasted monthly", as.character(original_name_list[[i]]), "generation in GB from VAR model"), 
           xlab = "Time series (month)", 
           ylab = "Gigawatt (GW)",
           col.y = "Dark Green")
}

```
### Export Result

```{r}

# generate result for each production type

Biomass <- data.frame(forecast$fcst$Biomass) %>% 
  mutate(type = "Biomass",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Biomass"]])

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Nuclear <- data.frame(forecast$fcst$Nuclear) %>% 
  mutate(type = "Nuclear",
         time = row_number(),
         carbon_intensity = 0)  

Other <- data.frame(forecast$fcst$Other) %>% 
  mutate(type = "Other",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Other"]])

Solar <- data.frame(forecast$fcst$Solar) %>% 
  mutate(type = "Solar",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Solar"]])

Hydro <- data.frame(forecast$fcst$Hydro) %>% 
  mutate(type = "Hydro",
         time = row_number(),
         carbon_intensity = 0)

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.GB <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Nuclear, Other, Solar, Hydro, Wind)

result.GB <- lapply(result.GB, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "GB")

result.GB

```


```{r}

# calculate carbon intensities

result.GB.carbon <- result.GB %>%
  group_by(time) %>% 
  mutate(GB_prediction = sum(fcst * carbon_intensity)/sum(fcst) * 1000) %>% 
  dplyr::select(c(time, GB_prediction)) %>% 
  distinct() %>% 
  cbind(data.frame(
    Datetime = c("2021-01-01","2021-02-01","2021-03-01","2021-04-01","2021-05-01"))) %>% 
  mutate(Datetime = as.Date(Datetime,"%Y-%m-%d"))

result.GB.carbon %>%
  kbl(caption = "VAR Predictions") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))


eu_monthly_carbon_intensity <- read_csv("eu_monthly_carbon_intensity.csv") %>% 
  mutate(GB_prediction = GB) %>% 
  dplyr::select(c(Datetime,GB_prediction)) %>% 
  rbind(subset(result.GB.carbon, select = c(Datetime,GB_prediction)))


ts_plot(as.ts(eu_monthly_carbon_intensity$GB_prediction),
        title = "Forecasted monthly average carbon intensity in GB from VAR model",
        color = "Green",
        Ygrid = TRUE,
        Xtitle = "Time series (month)",
        Ytitle = "Average Carbon Intensity (Kg/MWh)")

```

```{r}

# compare predictions to actual data

options(digits = 4)

actual_generation_GB <- read_csv("2021_actual_generation_GB.csv") %>% 
  # dplyr::select(c(Datetime,GB)) %>% 
  mutate(c_Biomass = Biomass * carbon_intensities$Biomass,
         c_Fossil.Brown.coal.Lignite = Fossil.Brown.coal.Lignite * carbon_intensities$Fossil.Brown.coal.Lignite,
         c_Fossil.Coal.derived.gas = Fossil.Coal.derived.gas * carbon_intensities$Fossil.Coal.derived.gas,
         c_Fossil.Gas = Fossil.Gas * carbon_intensities$Fossil.Gas,
         c_Fossil.Hard.coal = Fossil.Hard.coal * carbon_intensities$Fossil.Hard.coal,
         c_Fossil.Oil = Fossil.Oil * carbon_intensities$Fossil.Oil,
         c_Fossil.Peat = Fossil.Peat * carbon_intensities$Fossil.Peat,
         c_Geothermal = Geothermal * carbon_intensities$Geothermal,
         c_Hydro.Pumped.Storage = Hydro.Pumped.Storage * carbon_intensities$Hydro.Pumped.Storage,
         c_Hydro.Run.of.river.and.poundage = Hydro.Run.of.river.and.poundage * carbon_intensities$Hydro.Run.of.river.and.poundage,
         c_Hydro.Water.Reservoir = Hydro.Water.Reservoir * carbon_intensities$Hydro.Water.Reservoir,
         c_Nuclear = Nuclear * carbon_intensities$Nuclear,
         c_Other = Other * carbon_intensities$Other,
         c_Other.renewable = Other.renewable * carbon_intensities$Other.renewable,
         c_Solar = Solar * carbon_intensities$Solar,
         c_Waste = Waste * carbon_intensities$Waste,
         c_Wind.Offshore = Wind.Offshore * carbon_intensities$Wind.Offshore,
         c_Wind.Onshore = Wind.Onshore * carbon_intensities$Wind.Onshore) 

actual_generation_GB <- actual_generation_GB %>%
  # generate carbon intensity
  mutate(GB_actual = rowSums(actual_generation_GB[ ,22:39])/rowSums(actual_generation_GB[ ,4:21])*1000) %>% 
  dplyr::select(Datetime,GB_actual) %>% 
  drop_na()

actual_generation_GB 

result.GB.carbon


cbind(actual_generation_GB[1:5,], GB_prediction = result.GB.carbon$GB_prediction) %>% 
  mutate(Error_rate = percent((GB_prediction - GB_actual)/GB_actual)) %>% 
  kbl(caption = "VAR Predictions") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```


# Predict for all countries

## BE

TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.BE <- data1 %>% filter(Country == "BE")

# Create time series for each variable (exclude total generation)
Biomass.ts <- as.ts(data1.BE["Biomass"]) 
Fossil.Gas.ts <- as.ts(data1.BE["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.BE["Fossil.Hard.coal"]) 
Nuclear.ts <- as.ts(data1.BE["Nuclear"]) 
Other.ts <- as.ts(data1.BE["Other"]) 
Solar.ts <- as.ts(data1.BE["Solar"]) 
Hydro.ts <- as.ts(data1.BE["Hydro"]) 
Wind.ts <- as.ts(data1.BE["Wind"]) 

original_list <- list(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Hydro.ts, Wind.ts)

original_name_list <- list("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Hydro", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```

Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Hydro.ts, Wind.ts)

colnames(v1) <- cbind("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Hydro", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 1, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 1, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)


# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Biomass, forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Nuclear, forecast1$fcst$Other, forecast1$fcst$Solar, forecast1$fcst$Hydro, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Biomass, forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Nuclear, forecast2$fcst$Other, forecast2$fcst$Solar, forecast2$fcst$Hydro, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 1, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Biomass <- data.frame(forecast$fcst$Biomass) %>% 
  mutate(type = "Biomass",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Biomass"]])

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Nuclear <- data.frame(forecast$fcst$Nuclear) %>% 
  mutate(type = "Nuclear",
         time = row_number(),
         carbon_intensity = 0)  

Other <- data.frame(forecast$fcst$Other) %>% 
  mutate(type = "Other",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Other"]])

Solar <- data.frame(forecast$fcst$Solar) %>% 
  mutate(type = "Solar",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Solar"]])

Hydro <- data.frame(forecast$fcst$Hydro) %>% 
  mutate(type = "Hydro",
         time = row_number(),
         carbon_intensity = 0)

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.BE <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Nuclear, Other, Solar, Hydro, Wind)

result.BE <- lapply(result.BE, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "BE")

result.BE

```

## NO

TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.NO <- data1 %>% filter(Country == "NO")

Fossil.Gas.ts <- as.ts(data1.NO["Fossil.Gas"]) 
Other.ts <- as.ts(data1.NO["Other"]) 
Hydro.ts <- as.ts(data1.NO["Hydro"]) 
Wind.ts <- as.ts(data1.NO["Wind"]) 

original_list <- list(Fossil.Gas.ts, Other.ts, Hydro.ts, Wind.ts)

original_name_list <- list("Fossil.Gas", "Other", "Hydro", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```

Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Fossil.Gas.ts, Other.ts, Hydro.ts, Wind.ts)

colnames(v1) <- cbind("Fossil.Gas", "Other", "Hydro", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 10, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 9, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)


# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Fossil.Gas, forecast1$fcst$Other, forecast1$fcst$Hydro, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Fossil.Gas, forecast2$fcst$Other, forecast2$fcst$Hydro, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 10, type = "const", season = NULL, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Other <- data.frame(forecast$fcst$Other) %>% 
  mutate(type = "Other",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Other"]])

Hydro <- data.frame(forecast$fcst$Hydro) %>% 
  mutate(type = "Hydro",
         time = row_number(),
         carbon_intensity = 0)

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.NO <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Nuclear, Other, Solar, Hydro, Wind)

result.NO <- lapply(result.NO, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "NO")

result.NO

```

## FR

TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.FR <- data1 %>% filter(Country == "FR")

# Create time series for each variable (exclude total generation)
Biomass.ts <- as.ts(data1.FR["Biomass"]) 
Fossil.Gas.ts <- as.ts(data1.FR["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.FR["Fossil.Hard.coal"]) 
Nuclear.ts <- as.ts(data1.FR["Nuclear"]) 
Solar.ts <- as.ts(data1.FR["Solar"]) 
Hydro.ts <- as.ts(data1.FR["Hydro"]) 
Wind.ts <- as.ts(data1.FR["Wind"]) 

original_list <- list(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Solar.ts, Hydro.ts, Wind.ts)

original_name_list <- list("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Solar", "Hydro", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```


Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Solar.ts, Hydro.ts, Wind.ts)

colnames(v1) <- cbind("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Solar", "Hydro", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:59,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 6, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 6, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)

# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Biomass, forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Nuclear, forecast1$fcst$Solar, forecast1$fcst$Hydro, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Biomass, forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Nuclear, forecast2$fcst$Solar, forecast2$fcst$Hydro, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 6, type = "const", season = NULL, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Biomass <- data.frame(forecast$fcst$Biomass) %>% 
  mutate(type = "Biomass",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Biomass"]])

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Nuclear <- data.frame(forecast$fcst$Nuclear) %>% 
  mutate(type = "Nuclear",
         time = row_number(),
         carbon_intensity = 0)  

Solar <- data.frame(forecast$fcst$Solar) %>% 
  mutate(type = "Solar",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Solar"]])

Hydro <- data.frame(forecast$fcst$Hydro) %>% 
  mutate(type = "Hydro",
         time = row_number(),
         carbon_intensity = 0)

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.FR <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Nuclear, Solar, Hydro, Wind)

result.FR <- lapply(result.FR, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "FR")

result.FR

```


## NL

TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.NL <- data1 %>% filter(Country == "NL")

# Create time series for each variable (exclude total generation)
Biomass.ts <- as.ts(data1.NL["Biomass"]) 
Fossil.Gas.ts <- as.ts(data1.NL["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.NL["Fossil.Hard.coal"]) 
Nuclear.ts <- as.ts(data1.NL["Nuclear"]) 
Other.ts <- as.ts(data1.NL["Other"]) 
Solar.ts <- as.ts(data1.NL["Solar"]) 
Wind.ts <- as.ts(data1.NL["Wind"]) 

original_list <- list(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Wind.ts)

original_name_list <- list("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```

Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Nuclear.ts, Other.ts, Solar.ts, Wind.ts)

colnames(v1) <- cbind("Biomass","Fossil.Gas","Fossil.Hard.coal", "Nuclear", "Other", "Solar", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 6, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 6, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)

# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Biomass, forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Nuclear, forecast1$fcst$Solar, forecast1$fcst$Other, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Biomass, forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Nuclear, forecast2$fcst$Solar, forecast2$fcst$Other, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 1, type = "const", season = NULL, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Biomass <- data.frame(forecast$fcst$Biomass) %>% 
  mutate(type = "Biomass",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Biomass"]])

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Nuclear <- data.frame(forecast$fcst$Nuclear) %>% 
  mutate(type = "Nuclear",
         time = row_number(),
         carbon_intensity = 0)  

Other <- data.frame(forecast$fcst$Other) %>% 
  mutate(type = "Other",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Other"]])

Solar <- data.frame(forecast$fcst$Solar) %>% 
  mutate(type = "Solar",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Solar"]])

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.NL <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Nuclear, Other, Solar, Wind)

result.NL <- lapply(result.NL, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "NL")

result.NL

```

## DK


TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.DK <- data1 %>% filter(Country == "DK")

# Create time series for each variable (exclude total generation)
Biomass.ts <- as.ts(data1.DK["Biomass"]) 
Fossil.Gas.ts <- as.ts(data1.DK["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.DK["Fossil.Hard.coal"]) 
Solar.ts <- as.ts(data1.DK["Solar"]) 
Wind.ts <- as.ts(data1.DK["Wind"]) 

original_list <- list(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Solar.ts, Wind.ts)

original_name_list <- list("Biomass","Fossil.Gas","Fossil.Hard.coal", "Solar", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```

Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Biomass.ts, Fossil.Gas.ts, Fossil.Hard.coal.ts, Solar.ts, Wind.ts)

colnames(v1) <- cbind("Biomass","Fossil.Gas","Fossil.Hard.coal", "Solar", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 8, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 8, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)


# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Biomass, forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Solar, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Biomass, forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Solar, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 8, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Biomass <- data.frame(forecast$fcst$Biomass) %>% 
  mutate(type = "Biomass",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Biomass"]])

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Solar <- data.frame(forecast$fcst$Solar) %>% 
  mutate(type = "Solar",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Solar"]])

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.DK <- rbind(Biomass, Fossil.Gas, Fossil.Hard.coal, Solar, Wind)

result.DK <- lapply(result.DK, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "DK")

result.DK

```

## IE


TS data preparation

```{r, warning = FALSE}

# Extract country data
data1.IE <- data1 %>% filter(Country == "IE")

# Create time series for each variable (exclude total generation)
Fossil.Gas.ts <- as.ts(data1.IE["Fossil.Gas"]) 
Fossil.Hard.coal.ts <- as.ts(data1.IE["Fossil.Hard.coal"]) 
Other.ts <- as.ts(data1.IE["Other"]) 
Hydro.ts <- as.ts(data1.IE["Hydro"]) 
Wind.ts <- as.ts(data1.IE["Wind"]) 

original_list <- list(Fossil.Gas.ts, Fossil.Hard.coal.ts, Other.ts, Hydro.ts, Wind.ts)

original_name_list <- list("Fossil.Gas","Fossil.Hard.coal", "Other", "Hydro", "Wind")

# Visualize time series data for each energy generation type
for (i in (1:length(original_list))){
  p <- ts_plot(original_list[[i]], title = original_name_list[[i]])
  show(p)
}

# Use Phillips Perron to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- pp.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

# Use Augmented Dickey–Fuller Test to example if the variables are stationary or not
for (i in (1:length(original_list))){
  p <- adf.test(original_list[[i]])$p.value
  cat(original_name_list[[i]],": p value is", p,"\n")
}

```

Model

```{r, warning = FALSE}

# construct time series multivariables
v1 <- cbind(Fossil.Gas.ts, Fossil.Hard.coal.ts, Other.ts, Hydro.ts, Wind.ts)

colnames(v1) <- cbind("Fossil.Gas","Fossil.Hard.coal", "Other", "Hydro", "Wind")

# Train test splitting
training <- v1[1:55,]
testing <- v1[56:60,]

# select lag
lagselect <- VARselect(training, lag.max = 15, type = "const")
lagselect$selection
lagselect <- VARselect(training, lag.max = 15, season = 4, type = "const")
lagselect$selection

# Model building
Model1 <- VAR(training, p = 8, type = "const", season = NULL, exog = NULL) 
Model2 <- VAR(training, p = 8, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability1 <- stability(Model1, type = "OLS-CUSUM")
plot(Stability1)
Stability2 <- stability(Model2, type = "OLS-CUSUM")
plot(Stability2)

# Forcasting
forecast1 <- predict(Model1, n.ahead = 5, ci = 0.95)
forecast2 <- predict(Model2, n.ahead = 5, ci = 0.95)


# Compare results
# Model1 rmse
rmse_list <- list(forecast1$fcst$Fossil.Gas, forecast1$fcst$Fossil.Hard.coal, forecast1$fcst$Other, forecast1$fcst$Hydro, forecast1$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Model2 rmse

rmse_list <- list(forecast2$fcst$Fossil.Gas, forecast2$fcst$Fossil.Hard.coal, forecast2$fcst$Other, forecast2$fcst$Hydro, forecast2$fcst$Wind)

all <- 0
for (i in rmse_list){
  all = all + rmse(testing[1:5], i)
}
avg <- all / length(rmse_list)
avg

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast1, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}
for (i in (1:length(original_list))){
  p <- fanchart(forecast2, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  q <- autoplot(original_list[[i]])
  show(p)
  show(q)
}

```


Prediction

```{r, message=FALSE}

# Model building
Model <- VAR(v1, p = 8, type = "const", season = 4, exog = NULL) 

# Stability Test
Stability <- stability(Model, type = "OLS-CUSUM")
plot(Stability)

# Forcasting
forecast <- predict(Model, n.ahead = 5, ci = 0.95)

# Plot results
for (i in (1:length(original_list))){
  p <- fanchart(forecast, names = original_name_list[[i]], main = cat("Fanchart for",original_name_list[[i]]), xlab = "Horizon", ylab = original_name_list[[i]])
  show(p)
}

```

Export Result

```{r}

# generate result for each production type

Fossil.Gas <- data.frame(forecast$fcst$Fossil.Gas) %>% 
  mutate(type = "Fossil.Gas",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Gas"]])

Fossil.Hard.coal <- data.frame(forecast$fcst$Fossil.Hard.coal) %>% 
  mutate(type = "Fossil.Hard.coal",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Fossil.Hard.coal"]])

Other <- data.frame(forecast$fcst$Other) %>% 
  mutate(type = "Other",
         time = row_number(),
         carbon_intensity = carbon_intensities[["Other"]])

Hydro <- data.frame(forecast$fcst$Hydro) %>% 
  mutate(type = "Hydro",
         time = row_number(),
         carbon_intensity = 0)

Wind <- data.frame(forecast$fcst$Wind) %>% 
  mutate(type = "Wind",
         time = row_number(),
         carbon_intensity = 0)

# combine together

result.IE <- rbind(Fossil.Gas, Fossil.Hard.coal, Other, Hydro, Wind)

result.IE <- lapply(result.IE, function(x) ifelse(x < 0, 0, x)) %>% 
  data.frame() %>% 
  mutate(Country = "IE")

result.IE

```


# ALL

```{r}

# combine all predictions together

all_pred <-rbind(result.GB, result.BE, result.NO, result.FR, result.NL, result.DK, result.IE) 
all_pred

all_pred_carbon <- all_pred %>%
  group_by(Country, time) %>% 
  mutate(carbon = sum(fcst * carbon_intensity)/sum(fcst)) %>% 
  dplyr::select(c(time, Country, carbon)) %>% 
  distinct()
all_pred_carbon

# export to csv file

write.csv(all_pred, "eu_5mon_generation_prediction.csv", row.names = FALSE)
write.csv(all_pred_carbon, "eu_5mon_carbon_intensities_prediction.csv", row.names = FALSE)

```

