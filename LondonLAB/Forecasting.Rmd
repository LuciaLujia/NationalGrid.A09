---
title: "Forecasting"
author: "A09"
date: "12/04/2021"
output: html_document
---

```{r, warning=FALSE}

# Libraries
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo) # For computing moving averages 
library(GGally)
library(caret) 
library(lubridate)
library(rsample)
library(tseries)
library(forecast)
library(vars)
library(car)
# library(HDeconometrics)
library(Metrics)
library(scales) # stop abbreviated labeling

```

### Load ,clean and reformat data

```{r}
#Import flow and generation data 2019-2020
flow_2020= read_excel("Flow 2020.xlsx", sheet=2, na="NA")
eu_2020= read_excel("EU 2020 .xlsx", sheet=2, na="NA")
flow_2019= read_excel("Flow 2019.xlsx", sheet=2, na="NA")
eu_2019= read_excel("EU 2019 .xlsx", sheet=2, na="NA")

# Import flow and generation data from 2016-2018
flow_1618 <- read_excel("flow_2016_2018.xlsx")
eu_1618 <- read_csv("EU 2016-18.csv")

# Import demand data for France
demand_1618 <- read_csv("Demand_FR.csv")

# Load data on the carbon intensities of each generation technology
carbon_intensities <- read_excel("Technology CO2 Intensity.xlsx") 
carbon_intensities <- carbon_intensities[3, 2:21]

# Join data for 2020 and 2019
eu_1920 <- rbind(eu_2019, eu_2020) %>% 
# Remove negative generation, calculate total generation and compute difference between demand and generation
   mutate_at(3:23, function(x) ifelse(x<0,0,x)) 

# Make interconnector flows between GB and its neighbors consistent with the rest of the dataset
flow_2020 <- flow_2020 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

flow_2019 <- flow_2019 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

# Convert flow and generation data to monthly
flow_1920 <- as.data.frame(rbind(flow_2019, flow_2020)) %>%
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Datetime) %>% 
  summarise_at(1:59, sum, na.rm=TRUE) 
  
  
eu_1920 <- eu_1920 %>% 
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Datetime, Country) %>% 
  summarise_at(1:21, sum, na.rm=TRUE) 

eu_1618 <- eu_1618 %>% 
  mutate(Country= as.character(str_match_all(Country, "(?<=\\().+?(?=\\))")),
         Embedded.Wind=0,
         Embedded.other=0)
         

# Combine interconnector flows 2016-2020
flow <- rbind(flow_1618, flow_1920)

# Combine generation for years 2016-2020
eu_1920_mod <- eu_1920 %>% 
  dplyr::select(-Demand) %>% 
  ungroup()

eu_generation <- rbind(eu_1618, eu_1920_mod)

```

# Merge attributes

```{r}



# colnames(eu_1920)

# merged similar energy categories together
# category definitions https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Fossil_fuel
data1 <- eu_1920 %>% 
  
  mutate(Coal = Fossil.Brown.coal.Lignite + Fossil.Hard.coal,
         Gas = Fossil.Coal.derived.gas + Fossil.Gas,
         Hydro = Hydro.Pumped.Storage + Hydro.Run.of.river.and.poundage + Hydro.Water.Reservoir,
         Wind = Wind.Offshore + Wind.Onshore + Embedded.Wind,
         Other.renewable = Other.renewable + Geothermal) %>% 

  dplyr::select(-c(Fossil.Brown.coal.Lignite, Fossil.Coal.derived.gas, Fossil.Gas, Fossil.Hard.coal,
       Fossil.Oil, Fossil.Peat, Geothermal, Hydro.Pumped.Storage, Hydro.Run.of.river.and.poundage,
       Hydro.Water.Reservoir, Other, Wind.Offshore, Wind.Onshore, Embedded.Wind, Embedded.other))

data1

# colnames(data1)


# for daily --------------------------------------------------------
data1_day <- eu_1920_day %>% 
  
  mutate(Coal = Fossil.Brown.coal.Lignite + Fossil.Hard.coal,
         Gas = Fossil.Coal.derived.gas + Fossil.Gas,
         Hydro = Hydro.Pumped.Storage + Hydro.Run.of.river.and.poundage + Hydro.Water.Reservoir,
         Wind = Wind.Offshore + Wind.Onshore + Embedded.Wind,
         Other.renewable = Other.renewable + Geothermal) %>% 

  dplyr::select(-c(Fossil.Brown.coal.Lignite, Fossil.Coal.derived.gas, Fossil.Gas, Fossil.Hard.coal,
       Fossil.Oil, Fossil.Peat, Geothermal, Hydro.Pumped.Storage, Hydro.Run.of.river.and.poundage,
       Hydro.Water.Reservoir, Other, Wind.Offshore, Wind.Onshore, Embedded.Wind, Embedded.other))


```

# Trend plot

```{r, fig.width=12, fig.height=8, warning=FALSE}

# take FR and GB as examples
data2 <- data1 %>% 
  filter(Country == c("FR","GB"))

data2


# Plot

cbbPalette <- c("#000000", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

data2 %>% 
  pivot_longer(cols = colnames(data2)[3:12], names_to = "Energy.Type", values_to = "Megawatt") %>% 
  filter(Energy.Type != "Demand") %>% 
  ggplot(mapping = aes(x = Datetime, y = Megawatt, colour = Energy.Type)) +
  geom_line(size = 1.5) +
  theme_minimal() + 
  scale_y_continuous(labels = comma) + 
  labs(title = "Energy Generation", 
       x = "Months", 
       y = "Megawatt (MW)",
       caption = "Source: "
       ) + 
  facet_wrap(~Country) +
  scale_colour_manual(values=cbbPalette)




# for daily ---------------------------------------------------------------

# take FR and GB as examples
data2_day <- data1_day %>% 
  filter(Country == c("FR","GB"))


```


# Correlation

```{r, warning=FALSE}

# Correlation
data2 %>% 
  filter(Country == "FR") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)

data2 %>% 
  filter(Country == "GB") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)


# Correlation for daily --------------------------------------
data2_day %>% 
  filter(Country == "FR") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)

data2_day %>% 
  filter(Country == "GB") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)


data2_day %>% 
  filter(Country == "FR") %>% 
  dplyr::select(Nuclear, Hydro, Gas, Wind, Demand) %>% 
  ggpairs(progress = FALSE)

```

# Simple regression

```{r}

data2.GB <- data2 %>% 
  filter(Country == "GB") 

# simple regression
data2.GB %>% 
  ggplot(aes(x=Demand, y=Gas)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) +
  theme_minimal() +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma)

tslm(Gas ~ Demand, data=as.ts(data2.GB))


# for daily ----------------------------------------------------------------

data2.GB.day <- data2_day %>% 
  filter(Country == "GB") 

# simple regression for daily
data2.GB.day %>% 
  ggplot(aes(x=Demand, y=Gas)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) +
  theme_minimal() +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma)

tslm(Gas ~ Demand, data=as.ts(data2.GB.day))

```


# AR & WN & RW

```{r}

# autoregression
Demand.GB.ts <- as.ts(data2.GB["Demand"])
ts.plot(Demand.GB.ts)
acf(Demand.GB.ts)

Gas.GB.ts <- as.ts(data2.GB["Gas"])
ts.plot(Gas.GB.ts)
acf(Gas.GB.ts)

# white noise
arima(Demand.GB.ts, order = c(0, 0, 0))
mean(Demand.GB.ts)
var(Demand.GB.ts)



# autoregression for daily
Demand.GB.ts.day <- as.ts(data2.GB.day["Demand"])
ts.plot(Demand.GB.ts.day)
acf(Demand.GB.ts.day)

Gas.GB.ts.day <- as.ts(data2.GB.day["Gas"])
ts.plot(Gas.GB.ts.day)
acf(Gas.GB.ts.day)

# white noise for daily
arima(Gas.GB.ts.day, order = c(0, 0, 0))
mean(Gas.GB.ts.day)
var(Gas.GB.ts.day)



# random walk
diff(Demand.GB.ts) %>% ggtsdisplay()
ts.plot(diff(Demand.GB.ts))

# random walk for daily
diff(Demand.GB.ts.day) %>% ggtsdisplay()
ts.plot(diff(Demand.GB.ts.day))


```

# Moving average

```{r}



```


# ARIMA 

```{r}

# ARIMA (non seasonal) -----------------------------------------------

diff(Demand.GB.ts.day) %>% ggtsdisplay()

arima_model <- auto.arima(Demand.GB.ts.day)
summary(arima_model)

# fit <- arima(Demand.GB.ts.day, order=c(3,1,0))
# summary(fit)

fit <- arima(Demand.GB.ts.day, order=c(7,1,0))
summary(fit)
checkresiduals(fit)

autoplot(forecast(fit))

# ARIMA (seasonal) -----------------------------------------------

Demand.GB.ts.day %>% diff(lag = 7) %>% ggtsdisplay()
Demand.GB.ts.day %>% diff(lag = 7) %>% diff() %>% ggtsdisplay()

Demand.GB.ts.day %>%
  arima(order=c(7,1,1), seasonal=c(0,1,1)) %>%
  residuals() %>% ggtsdisplay()

# Demand.GB.ts.day %>%
#   arima(order=c(7,1,5), seasonal=c(0,1,1)) %>%
#   residuals() %>% ggtsdisplay()

fit <- arima(Demand.GB.ts.day, order=c(7,1,1), seasonal=c(0,1,1))
summary(fit)
checkresiduals(fit)

autoplot(forecast(fit))

```

# TBD

```{r}

# Dynamic regression

# Dynamic harmonic regression

# TBATS

```

