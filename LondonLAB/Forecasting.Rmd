---
title: "Forecasting"
author: "A09"
date: "12/04/2021"
output: html_document
---

```{r}

# Libraries
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(zoo) # For computing moving averages 
library(GGally)
library(caret) 
library(lubridate)
library(rsample)
library(tseries)
library(forecast)
library(vars)
library(car)
# library(HDeconometrics)
library(Metrics)
library(scales) # stop abbreviated labeling

```

### Load ,clean and reformat data

```{r}
#Import flow and generation data 2019-2020
flow_2020= read_excel("Flow 2020.xlsx", sheet=2, na="NA")
eu_2020= read_excel("EU 2020 .xlsx", sheet=2, na="NA")
flow_2019= read_excel("Flow 2019.xlsx", sheet=2, na="NA")
eu_2019= read_excel("EU 2019 .xlsx", sheet=2, na="NA")

# Import flow and generation data from 2016-2018
flow_1618 <- read_excel("flow_2016_2018.xlsx")
eu_1618 <- read_csv("EU 2016-18.csv")

# Import demand data for France
#demand_1618 <- read_csv("Demand_FR.csv")

# Load data on the carbon intensities of each generation technology
carbon_intensities <- read_excel("Technology CO2 Intensity.xlsx") 
carbon_intensities <- carbon_intensities[3, 2:21]

# Join data for 2020 and 2019
eu_1920 <- rbind(eu_2019, eu_2020) %>% 
# Remove negative generation, calculate total generation and compute difference between demand and generation
   mutate_at(3:23, function(x) ifelse(x<0,0,x)) 

# Make interconnector flows between GB and its neighbors consistent with the rest of the dataset
flow_2020 <- flow_2020 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

flow_2019 <- flow_2019 %>% 
  mutate(GB.FR= -FR.GB,
         GB.NL = -NL.GB,
         GB.BE= -BE.GB,
         GB.IE= -IE.GB,
         GB.NIR= -NIR.GB
         )

# Convert flow and generation data to monthly
flow_1920 <- as.data.frame(rbind(flow_2019, flow_2020)) %>%
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Datetime) %>% 
  summarise_at(1:59, sum, na.rm=TRUE) 
  
  
eu_1920 <- eu_1920 %>% 
  mutate(Datetime= floor_date(Datetime, "month")) %>% 
  group_by(Country, Datetime) %>% 
  summarise_at(1:21, sum, na.rm=TRUE) 



```

# Merge attributes

```{r}

# colnames(eu_1920)


# merged similar energy categories together
# category definitions https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Fossil_fuel
data1 <- eu_1920 %>% 
  
  mutate(Coal = Fossil.Brown.coal.Lignite + Fossil.Hard.coal,
         Gas = Fossil.Coal.derived.gas + Fossil.Gas,
         Hydro = Hydro.Pumped.Storage + Hydro.Run.of.river.and.poundage + Hydro.Water.Reservoir,
         Wind = Wind.Offshore + Wind.Onshore + Embedded.Wind,
         Other.renewable = Other.renewable + Geothermal) %>% 

  dplyr::select(-c(Fossil.Brown.coal.Lignite, Fossil.Coal.derived.gas, Fossil.Gas, Fossil.Hard.coal,
       Fossil.Oil, Fossil.Peat, Geothermal, Hydro.Pumped.Storage, Hydro.Run.of.river.and.poundage,
       Hydro.Water.Reservoir, Other, Wind.Offshore, Wind.Onshore, Embedded.Wind, Embedded.other))

data1

# colnames(data1)


```

# Trend plot

```{r, fig.width=12, fig.height=8}

# take FR and GB as examples
data2 <- data1 %>% 
  filter(Country == c("FR","GB"))

data2


# Plot

cbbPalette <- c("#000000", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

data2 %>% 
  pivot_longer(cols = colnames(data2)[3:12], names_to = "Energy.Type", values_to = "Megawatt") %>% 
  filter(Energy.Type != "Demand") %>% 
  ggplot(mapping = aes(x = Datetime, y = Megawatt, colour = Energy.Type)) +
  geom_line(size = 1.5) +
  theme_minimal() + 
  scale_y_continuous(labels = comma) + 
  labs(title = "Energy Generation", 
       x = "Months", 
       y = "Megawatt (MW)",
       caption = "Source: "
       ) + 
  facet_wrap(~Country) +
  scale_colour_manual(values=cbbPalette)
  


```


# Correlation

```{r, warning=FALSE}

# Correlation
data2 %>% 
  filter(Country == "FR") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)

data2 %>% 
  filter(Country == "GB") %>% 
  ggcorr(method = c("pairwise", "pearson"), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)


# Time series auto-correlation
data2 %>% 
  filter(Country == "GB") %>% 
  dplyr::select(-Datetime) %>% 
  acf(lag.max = 6, plot = FALSE)

```

# Time series base model

```{r}

# autoregression

# random walk

# moving average

# ARIMA

# Dynamic regression

# Dynamic harmonic regression

# TBATS

```

